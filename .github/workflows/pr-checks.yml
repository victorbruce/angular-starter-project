name: PR Checks

# Only runs on pull requests
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Validate PR
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for better diff

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Require PR titles to follow conventional commits
          # Examples: "feat: add new feature", "fix: bug fix", "docs: update readme"
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
        continue-on-error: true

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "âŒ Merge conflicts detected. Please resolve conflicts before merging."
            exit 1
          fi
          echo "âœ… No merge conflicts detected"

      - name: PR size check
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "âš ï¸  Warning: Large PR with $FILES_CHANGED files changed. Consider splitting into smaller PRs."
          fi

          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "âš ï¸  Warning: Large PR with $LINES_CHANGED lines changed. Consider splitting into smaller PRs."
          fi

  # Run quality checks
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run all checks
        run: |
          echo "Running lint..."
          npm run lint

          echo "Running format check..."
          npm run format:check

          echo "Running tests..."
          npm test -- --coverage --watchAll=false

          echo "Building application..."
          npm run build -- --configuration production

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ¤– PR Quality Check Results\n\n';

            if (fs.existsSync('./coverage/coverage-summary.json')) {
              const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              
              comment += '### ðŸ“Š Test Coverage\n\n';
              comment += `- **Lines**: ${total.lines.pct}%\n`;
              comment += `- **Statements**: ${total.statements.pct}%\n`;
              comment += `- **Functions**: ${total.functions.pct}%\n`;
              comment += `- **Branches**: ${total.branches.pct}%\n\n`;
            }

            comment += '### âœ… All checks passed!\n';
            comment += 'This PR is ready for review.\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true
